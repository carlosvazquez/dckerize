version: '2'
services:
  webapp_setup:
    build:
      context: .
      dockerfile: Dockerfile.development
    depends_on:
      - <%= @db %>
    environment:
      - PASSENGER_APP_ENV=development
    entrypoint: ./setup.sh
  webapp:
    container_name: <%= @name %>
    build:
      context: .
      dockerfile: Dockerfile.development
    depends_on:
      - <%= @db %>
      - webapp_setup
    ports:
      - "80:80"
    environment:
      - PASSENGER_APP_ENV=development
    volumes:
      - .:/home/app/webapp
  <%- @extras.each do |extra| -%>
  <%= extra.service_name %>:
    image: <%= extra.image %>
    name: <%= @name %>-<%= extra.service_name %>
  <%- end -%>

  data:
    image: <%= @db %>
    <%- if @db_password -%>
    environment:
      - <%= @db_password %>=secretpassword
    <%- end -%>
    volumes:
      - <%= @data_volume_dir %>
    command: "true"
  <%= @db_service_name %>:
    image: <%= @db %>
    <%- if @db_password -%>
    environment:
      - <%= @db_password %>=secretpassword
    <%- end -%>
    volumes_from:
      - data
